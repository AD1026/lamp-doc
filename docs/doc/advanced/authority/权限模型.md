---
title: 权限模型
index: false
category:
  - 开发进阶
tag:
  - 开发进阶
  - 权限模型
---

## E-R图

《灯灯》的权限设计方案，采用==LRBAC==（Lamp Role-Based Access Control，lamp系统扩展的==RBAC==），LRBAC是在==RBAC0==（Role-Based Access Control，基于角色的访问控制）的基础上做了一些改进。

下方的E-R图中，黄色是主数据表，绿色是关联表(rel结尾的都是关联表)，def\_前缀的表在lamp_defaults库，base\_ 前缀的表在lamp_base_{TenantId}库。



@slidestart solarized

### 员工-部门-角色-资源关系E-R图

![员工-部门-角色-资源关系E-R图](/images/advanced/LRBAC.png)

---

### 租户-应用-资源关系E-R图

![租户-应用-资源关系E-R图](/images/advanced/LRBAC2.png)

@slideend



在员工-部门-角色-资源关系E-R图中：

1. 员工-角色-资源：传统的RBAC0模型，一个员工在不同的场景下可以拥有不同的角色，每个角色拥有不同的资源。
2. 员工-部门-角色-资源：lamp系统扩展模型，一个员工可以属于多个部门，每个部门可以绑定多个的**角色**，那么员工就拥有了这些部门下角色的权限。

在租户-应用-资源关系E-R图中：

1. 员工-租户-应用：一个用户可以加入多个租户，每个租户可以有不同的应用



## LRBAC概念声明

《灯灯》系统的权限体系分为5个步骤：

1. 配置
2. 授权
3. 认证
4. 鉴权
5. 权限控制

::: tip 场景举例

1. 配置：开发者提前在系统重创建好权限
2. 授权：运营者给你授予具体的权限
3. 认证：你登录系统时，对你的身份核对
4. 鉴权：登录后，查询你有那些权限
5. 权限控制：假设运营者只给了你2个菜单、3个按钮的权限，那你就只能访问或使用这些菜单和按钮。

:::



### 配置

配置是指开发者在开发阶段，通过开发运营系统创建资源的过程。 通俗点：

- 开发者在**开发运营系统** - **应用管理** - **应用维护**页面，创建应用的过程。

  ![](/images/intro/操作_应用管理_新建应用.png =200x)

- 开发者在**开发运营系统** - **应用管理** - **资源维护** 页面，创建系统所需的菜单、视图、按钮、字段、接口、数据等资源的过程。

  ![](/images/intro/操作_应用管理_资源_新增.png)

### 授权

授权是指资源所有者赋予执行者指定范围的资源操作权限。通俗点：
- 平台管理员（运营者）在**开发运营系统** - **应用管理** - **应用资源授权** 给租户授权应用和资源的过程

  ![](/images/intro/操作_应用授权管理_应用授权.png =1000x)

- 租户管理员（租户）在**基础平台** - **系统功能** - **角色权限维护** 给普通员工授予访问==资源==的权限。

  ![](/images/intro/上手开发_权限模型_授权界面.png =1000x)

### 认证

认证是指确认访问者的身份。通俗点：用户通过用户名、手机号、电子邮箱等账号登录系统时，验证用户账号密码是否正确。

![](/images/advanced/开发进阶_权限模型_认证鉴权请求接口.png =1000x)

### 鉴权

鉴权是指对于一个声明者所声明的身份权利的真实性进行鉴别确认的过程。鉴权是一个承上启下的一个环节，下游是权限控制。通俗点：

- 登陆后通过 `/anyone/visible/router` 和 `/anyone/visible/resource` 接口获取访问者的身份，获取访问者的权限。

![](/images/advanced/开发进阶_权限模型_认证鉴权请求接口.png =1000x)

接口实现参考：ResourceController#visible  和 ResourceController#myRouter



### 权限控制

权限控制是指对可执行的各种操作组合配置为权限列表，然后根据执行者的权限，若其操作在权限范围内则允许执行，否则禁止。

结合本系统来讲，就是通过网关后端过滤器或前端指令等方式控制用户是否可以访问某个**资源**。





## LRBAC资源类型

《灯灯》系统的权限体系包含7种资源：

1. 应用
2. 菜单
3. 视图
4. 按钮
5. 字段
6. 接口
7. 数据

::: tip

本文档提到的资源，可以理解为应用、菜单、视图、按钮、字段、接口、数据等类型的资源。

应用和接口是比较特殊的资源，应用单独在应用维护页面配置，接口需要关联到菜单、视图、按钮，其他资源在资源维护页面配置。

:::

### 应用

::: tip

设计之初，一直在纠结是否把应用也当成一种资源类型，但考虑到应用的字段、属性等太具有特殊性，所以将应用独立出来，在**应用维护**页面进行配置应用属性，**应用资源授权**页面给租户授权应用。

:::

应用是一种特殊的资源，在"应用维护"页面配置应用的属性。

### 菜单

系统左侧和顶部显示的菜单，无论是1级、2级还是N级菜单，无论鼠标点击之后是折叠效果（有些系统层折叠菜单为**目录**）还是跳转页面，在本系统都统称为菜单。

菜单权限的控制，是通过后端接口控制，也就是说后端返回的菜单数据，会自动隐藏没权限的菜单页面。获取用户拥有的菜单和视图的接口是同一个。

![](/images/intro/操作_应用管理_资源_菜单.png)



::: info 名词声明

在本文档中，一些特殊名词含义如下：

1. 目录：就是上图中的①、②
2. 折叠菜单：也是上图中的①、②
3. 普通菜单：上图中的③就是普通菜单

:::

### 视图

视图，即隐藏的菜单。

如：在租户维护页面，点击操作栏的==查看==按钮后，会跳转到==查看企业信息==页面。查看企业信息就是一个视图，它不会显示在左侧菜单中，但却跟菜单一样通过vue-router控制路由跳转。

视图权限的控制，是通过后端接口控制，也就是说后端返回的视图数据，会自动隐藏没权限的视图页面。获取用户拥有的菜单和视图的接口是同一个。

![](/images/intro/操作_应用管理_资源_视图举例.png)



### 按钮

按钮就是页面上的一个按钮。如：

![](/images/advanced/开发进阶_权限模型_按钮.png)

按钮权限的控制，后端接口会返回的用户拥有的所有按钮权限编码，前端通过自定义指令或filter控制按钮显示隐藏。



### 字段

完整的字段权限控制应同时控制前端页面的展现形式以及后端接口的返回，且通过以下方式控制：

1. 显隐

   张三能看“金额”字段，李四不能看。前端隐藏该字段，后端接口不返回该字段。

2. 脱敏

   张三看到完整的“身份证”字段，李四看到的数据自动脱敏。前端不处理该字段，后端接口返回数据时自动脱敏。

3. 可编辑

   张三能修改“金额”字段，李四不能修改。前端控制“金额”字段的展现方式，后端也要控制李四无法修改该字段。

但目前为止（4.13.0版本），《灯灯》仅实现了==在前端控制字段的显示和隐藏==，其他功能均未实现。完整功能，敬请期待。

已实现方案为：字段权限的控制，后端接口会返回的用户拥有的所有字段权限编码，前端通过自定义指令或filter控制字段显示隐藏。



### 接口

接口又称URI、API，==接口==不是资源类型的一个选项，而是在菜单、视图、按钮等资源的一个属性，他必须关联这3种**资源**上。

在授权时，只要勾选了菜单、视图、按钮，用户就自动拥有了这些菜单、视图、按钮关联的接口。

接口权限的控制是通过后端lamp-gateway-server的过滤器实现。

![](/images/intro/操作_应用管理_资源_接口说明.png)



::: details 资源和接口关联说明

![](/images/advanced/开发进阶_权限模型_接口.png)

:::

### 数据

数据指数据权限。数据权限只能配置在菜单或视图下。

比如：可以在菜单“消息管理”下配置“数据”，需要配置几个数据资源，完全取决于你的业务需要如何控制“消息管理”的数据。若你只想控制查询本人、查询本单位、查询全部数据3个维度，则只需要在“消息管理”下配置3个“数据”。

::: tip

数据权限的使用场景一般是，部门经理能看到A页面的本部门的数据，普通员工只能看自己的数据。所以数据权限只能挂载到菜单或视图下。

但由于前后分离项目，前端的页面和后端的接口没有依赖和关联关系，如：

前端 `/msg/index` 页面配置了本部门、本人、全部数据3个数据权限，对应后端的数据权限接口`/api/base/msg/page`接口。此时前其他页面`/msg/xxx`也调用了`/api/base/msg/page`接口，则页面`/msg/xxx`调用时，接口返回的数据，不会被数据权限过滤。

:::
